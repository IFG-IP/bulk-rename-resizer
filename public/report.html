<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>統計レポートツール</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- day.js for date manipulation -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>

    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
        .summary-card {
            transition: all 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: all 0.2s ease-out;
        }
        .modal-leave {
            opacity: 1;
            transform: scale(1);
        }
        .modal-leave-active {
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.2s ease-in;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 tracking-tight">統計レポート</h1>
            <p class="text-gray-500 mt-1">画像加工ツールの利用状況を分析します。</p>
        </header>

        <!-- Data Source Info -->
        <div id="data-source-info" class="mb-4 h-6"></div>


        <!-- Loading State -->
        <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
            <div class="text-center">
                <svg class="animate-spin h-12 w-12 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg font-semibold text-gray-700">データを読み込んでいます...</p>
            </div>
        </div>

        <!-- Main Content (hidden until loaded) -->
        <main id="main-content" class="opacity-0 transition-opacity duration-500">
            <!-- Settings & Filters -->
            <div class="bg-white p-6 rounded-2xl shadow-md mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 items-end">
                    <!-- Period Filter -->
                    <div>
                        <label for="period-select" class="block text-sm font-medium text-gray-700 mb-1">期間</label>
                        <select id="period-select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="this_month">今月</option>
                            <option value="last_month">先月</option>
                            <option value="all">全期間</option>
                        </select>
                    </div>

                    <!-- Manual Work Time Setting -->
                    <div>
                        <label for="manual-time-input" class="block text-sm font-medium text-gray-700 mb-1">基準値設定 (手作業/枚)</label>
                        <div class="flex items-center">
                            <input type="number" id="manual-time-input" value="30" class="w-full p-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <span class="inline-flex items-center px-3 text-gray-600 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg">秒</span>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1 invisible">アクション</label> <!-- Spacer for alignment -->
                        <div class="flex items-center space-x-3">
                            <button id="update-button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                                <span>更新</span>
                            </button>
                            <button id="show-cache-button" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors flex items-center justify-center">
                               <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><path d="M20 12.58A10 10 0 1 1 12 2a10 10 0 0 1 10 10z"/><path d="M12 2v20"/><path d="M2 12h20"/></svg>
                                <span>キャッシュ表示</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-4">
                <div class="summary-card bg-white p-6 rounded-2xl shadow-md flex items-center">
                    <div class="bg-blue-100 p-4 rounded-full mr-5">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-600"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="M13 13l6 6"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">総利用回数</p>
                        <p id="total-usage" class="text-3xl font-bold">0 回</p>
                    </div>
                </div>
                <div class="summary-card bg-white p-6 rounded-2xl shadow-md flex items-center">
                    <div class="bg-green-100 p-4 rounded-full mr-5">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-green-600"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">累計処理枚数</p>
                        <p id="total-files" class="text-3xl font-bold">0 枚</p>
                    </div>
                </div>
                <div class="summary-card bg-white p-6 rounded-2xl shadow-md flex items-center">
                     <div class="bg-purple-100 p-4 rounded-full mr-5">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-purple-600"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">累計削減時間 (目安)</p>
                        <p id="time-saved" class="text-3xl font-bold">0 時間</p>
                    </div>
                </div>
            </div>
             <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="summary-card bg-white p-6 rounded-2xl shadow-md">
                    <p class="text-sm text-gray-500">平均自動化率</p>
                    <p id="avg-automation-rate" class="text-3xl font-bold mt-1">0 %</p>
                </div>
                <div class="summary-card bg-white p-6 rounded-2xl shadow-md">
                    <p class="text-sm text-gray-500">平均処理速度/枚</p>
                    <p id="avg-processing-speed" class="text-3xl font-bold mt-1">0 秒/枚</p>
                </div>
                <div class="summary-card bg-white p-6 rounded-2xl shadow-md">
                    <p class="text-sm text-gray-500">エラー発生率</p>
                    <p id="error-rate" class="text-3xl font-bold mt-1">0 %</p>
                </div>
            </div>


            <!-- Charts -->
            <div class="grid grid-cols-1 gap-8 mb-8">
                 <div class="bg-white p-6 rounded-2xl shadow-md relative h-96">
                    <h3 class="text-lg font-semibold mb-4">利用状況推移</h3>
                    <canvas id="time-series-chart"></canvas>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-md relative h-96">
                    <h3 class="text-lg font-semibold mb-4">業種別利用ランキング</h3>
                    <canvas id="industry-chart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-md relative h-96">
                    <h3 class="text-lg font-semibold mb-4">ブラウザ比率</h3>
                    <canvas id="browser-chart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-md relative h-96">
                    <h3 class="text-lg font-semibold mb-4">ファイル形式</h3>
                    <canvas id="file-type-chart"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                 <div class="bg-white p-6 rounded-2xl shadow-md relative h-96">
                    <h3 class="text-lg font-semibold">処理時間 vs ファイル数 <span class="text-sm font-normal text-gray-500 ml-2">相関係数: <span id="file-count-correlation" class="font-bold">0.00</span></span></h3>
                    <canvas id="file-count-scatter-chart"></canvas>
                </div>
                 <div class="bg-white p-6 rounded-2xl shadow-md relative h-96">
                    <h3 class="text-lg font-semibold">処理時間 vs ファイルサイズ <span class="text-sm font-normal text-gray-500 ml-2">相関係数: <span id="file-size-correlation" class="font-bold">0.00</span></span></h3>
                    <canvas id="file-size-scatter-chart"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-8">
                 <div class="md:col-span-1 bg-white p-6 rounded-2xl shadow-md relative h-96">
                    <h3 class="text-lg font-semibold mb-4">アップロード方法</h3>
                    <canvas id="upload-method-chart"></canvas>
                </div>
                <div class="md:col-span-2 bg-white p-6 rounded-2xl shadow-md">
                    <h3 class="text-lg font-semibold mb-4">平均処理時間の内訳 (秒)</h3>
                    <div id="time-breakdown-container" class="space-y-4 text-lg pt-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">サムネイル生成:</span>
                            <span id="time-breakdown-thumbnail" class="font-bold text-gray-800">0.0</span>
                        </div>
                         <div class="flex justify-between items-center">
                            <span class="text-gray-600">リサイズ処理:</span>
                            <span id="time-breakdown-resize" class="font-bold text-gray-800">0.0</span>
                        </div>
                         <div class="flex justify-between items-center">
                            <span class="text-gray-600">ZIP生成:</span>
                            <span id="time-breakdown-zip" class="font-bold text-gray-800">0.0</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/60 z-50 p-4 hidden items-center justify-center">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-lg p-8 modal-enter">
            <h3 class="text-xl font-bold text-gray-800">確認</h3>
            <p class="text-gray-600 mt-2 mb-6">本当にキャッシュをクリアしますか？</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel-button" class="px-6 py-2 rounded-lg text-gray-700 font-semibold bg-gray-200 hover:bg-gray-300 transition">キャンセル</button>
                <button id="confirm-ok-button" class="px-6 py-2 rounded-lg text-white font-bold bg-red-600 hover:bg-red-700 transition">クリアする</button>
            </div>
        </div>
    </div>


    <!-- Cache Viewer Modal -->
    <div id="cache-modal" class="fixed inset-0 bg-black/60 z-50 p-4 hidden items-center justify-center">
        <div class="bg-white w-full max-w-6xl h-[90vh] flex flex-col rounded-2xl shadow-lg modal-enter">
            <header class="flex items-center justify-between p-5 border-b border-gray-200">
                <h2 id="cache-modal-title" class="text-xl font-bold text-gray-800">localStorage キャッシュデータ</h2>
                <div class="flex items-center space-x-4">
                    <button id="clear-cache-button" class="bg-red-100 text-red-700 font-bold py-2 px-4 rounded-lg hover:bg-red-200 transition-colors flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        <span>キャッシュをクリア</span>
                    </button>
                    <button id="close-cache-button" class="text-gray-500 hover:text-gray-800 rounded-full p-1 hover:bg-gray-200/60 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            </header>
            <main class="p-6 flex-grow overflow-y-auto bg-gray-50">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm divide-y divide-gray-200">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 font-semibold text-left text-gray-600">日時</th>
                                <th class="px-4 py-2 font-semibold text-left text-gray-600">業種</th>
                                <th class="px-4 py-2 font-semibold text-left text-gray-600">ファイル数</th>
                                <th class="px-4 py-2 font-semibold text-left text-gray-600">合計サイズ(MB)</th>
                                <th class="px-4 py-2 font-semibold text-left text-gray-600">処理時間(s)</th>
                                <th class="px-4 py-2 font-semibold text-left text-gray-600">滞在時間(s)</th>
                                <th class="px-4 py-2 font-semibold text-left text-gray-600">入稿ID</th>
                                <th class="px-4 py-2 font-semibold text-left text-gray-600">アップロード方法</th>
                                <th class="px-4 py-2 font-semibold text-left text-gray-600">ファイル形式</th>
                                <th class="px-4 py-2 font-semibold text-left text-gray-600">時間内訳</th>
                                <th class="px-4 py-2 font-semibold text-left text-gray-600">エラー</th>
                                <th class="px-4 py-2 font-semibold text-left text-gray-600">UA</th>
                                <th class="px-4 py-2 font-semibold text-left text-gray-600">セッションID</th>
                            </tr>
                        </thead>
                        <tbody id="cache-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                    <p id="empty-cache-message" class="hidden text-center text-gray-500 py-8">キャッシュは空です。</p>
                </div>
            </main>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBGUOj0RMHxD2dGyXTPrRHUkDJ2m_kKpto",
            authDomain: "statistical-report-system.firebaseapp.com",
            projectId: "statistical-report-system",
            storageBucket: "statistical-report-system.firebasestorage.app",
            messagingSenderId: "1057569871454",
            appId: "1:1057569871454:web:bf28ff36f9312f6a9386cf",
            measurementId: "G-SFX8PHGJ2C"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- State and Cache ---
        let dataCache = {};
        let timeSeriesChart = null;
        let industryChart = null;
        let browserChart = null;
        let fileTypeChart = null;
        let uploadMethodChart = null;
        let fileCountScatterChart = null;
        let fileSizeScatterChart = null;


        /**
         * Saves the current data cache to localStorage after converting Timestamps.
         */
        function saveCacheToLocal(cache) {
            const serializableCache = {};
            for (const period in cache) {
                serializableCache[period] = cache[period].map(log => {
                    const logCopy = { ...log };
                    if (logCopy.eventTimestamp && typeof logCopy.eventTimestamp.toMillis === 'function') {
                        logCopy.eventTimestamp = logCopy.eventTimestamp.toMillis();
                    }
                    return logCopy;
                });
            }
            localStorage.setItem('dataCache', JSON.stringify(serializableCache));
        }

        /**
         * Loads and reconstructs the data cache from localStorage.
         * @returns {object} The reconstructed data cache.
         */
        function loadCacheFromLocal() {
            const storedCacheJSON = localStorage.getItem('dataCache');
            if (!storedCacheJSON) {
                return {};
            }
            try {
                const parsedCache = JSON.parse(storedCacheJSON);
                const reconstructedCache = {};
                for (const period in parsedCache) {
                    reconstructedCache[period] = parsedCache[period].map(log => {
                        if (log.eventTimestamp) {
                            const millis = log.eventTimestamp;
                            // Create a mock Timestamp object that works with dayjs
                            log.eventTimestamp = {
                                toDate: () => new Date(millis),
                                toMillis: () => millis
                            };
                        }
                        return log;
                    });
                }
                return reconstructedCache;
            } catch (error) {
                console.error("Failed to parse cache from localStorage:", error);
                return {}; // Return empty if cache is corrupted
            }
        }

        // Initialize cache from local storage on page load
        dataCache = loadCacheFromLocal();

        /**
         * Fetches usage logs from Firestore based on the selected period.
         * @param {string} period - The time period ('this_month', 'last_month', 'all').
         * @param {Timestamp|null} startAfterTimestamp - Firestore Timestamp to fetch documents after.
         */
        async function fetchUsageLogs(period = 'this_month', startAfterTimestamp = null) {
            const logsCollection = collection(db, 'usage_logs');
            dayjs.extend(dayjs_plugin_utc);
            dayjs.extend(dayjs_plugin_timezone);
            dayjs.tz.setDefault("Asia/Tokyo");

            const queryConditions = [];

            if (period !== 'all') {
                let startDate, endDate;
                const now = dayjs().tz();
                if (period === 'this_month') {
                    startDate = now.startOf('month');
                    endDate = now.endOf('month');
                } else if (period === 'last_month') {
                    const lastMonth = now.subtract(1, 'month');
                    startDate = lastMonth.startOf('month');
                    endDate = lastMonth.endOf('month');
                }
                queryConditions.push(where('eventTimestamp', '>=', Timestamp.fromDate(startDate.toDate())));
                queryConditions.push(where('eventTimestamp', '<=', Timestamp.fromDate(endDate.toDate())));
            }
            
            if (startAfterTimestamp) {
                queryConditions.push(where('eventTimestamp', '>', startAfterTimestamp));
            }

            const q = query(logsCollection, ...queryConditions);
            const querySnapshot = await getDocs(q);
            const logs = [];
            querySnapshot.forEach((doc) => {
                logs.push(doc.data());
            });

            logs.sort((a, b) => a.eventTimestamp.toMillis() - b.eventTimestamp.toMillis());
            return logs;
        }

        /**
         * Updates the data source information UI element.
         * @param {string} source - "Firestore", "キャッシュ", etc.
         * @param {number} totalCount - The total number of log entries.
         * @param {number|null} newCount - The number of new entries fetched.
         */
        function updateDataSourceInfo(source, totalCount, newCount = null) {
            const infoEl = document.getElementById('data-source-info');
            let message = '';
            let iconColor = 'text-gray-500';

            if (source === 'Firestore') {
                message = `表示データ: <strong>Firestore</strong>から取得 (${totalCount.toLocaleString()}件)`;
                iconColor = 'text-blue-500';
            } else if (source === 'キャッシュ (最新)') {
                message = `表示データ: <strong>キャッシュ</strong>から取得 (${totalCount.toLocaleString()}件) - データは最新です`;
                 iconColor = 'text-green-500';
            } else if (source === 'キャッシュ') {
                 message = `表示データ: <strong>キャッシュ</strong>から取得 (${totalCount.toLocaleString()}件)`;
                 iconColor = 'text-green-500';
            } else if (source === 'キャッシュ + Firestore') {
                const cachedCount = totalCount - (newCount || 0);
                message = `表示データ: <strong>キャッシュ</strong> (${cachedCount.toLocaleString()}件) + <strong>Firestore</strong>から新規 (${(newCount || 0).toLocaleString()}件) を取得`;
                iconColor = 'text-yellow-500';
            }

            if (message) {
                 infoEl.innerHTML = `
                    <div class="flex items-center bg-gray-200 text-gray-700 text-xs font-semibold px-3 py-1 rounded-full w-fit transition-all duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2 ${iconColor}"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                        <span>${message}</span>
                    </div>
                `;
            } else {
                infoEl.innerHTML = '';
            }
        }

        /**
         * Renders the entire dashboard based on provided log data.
         * @param {Array} logs - The array of log documents to render.
         */
        function renderDashboardFromLogs(logs) {
            const manualTime = parseInt(document.getElementById('manual-time-input').value) || 30;

            // --- 1. Update Summary Cards ---
            const totalUsage = logs.length;
            const totalFiles = logs.reduce((sum, log) => sum + (log.fileCount || 0), 0);
            const totalProcessingTime = logs.reduce((sum, log) => sum + (log.processingTime || 0), 0);
            const estimatedManualTime = totalFiles * manualTime;
            const timeSavedInSeconds = estimatedManualTime - totalProcessingTime;
            const timeSavedInHours = timeSavedInSeconds > 0 ? (timeSavedInSeconds / 3600).toFixed(1) : 0;
            
            const totalSessionDuration = logs.reduce((sum, log) => sum + (log.sessionDuration || 0), 0);
            const errorCount = logs.filter(log => log.errors && log.errors.length > 0).length;

            const avgAutomationRate = totalSessionDuration > 0 ? (totalProcessingTime / totalSessionDuration * 100) : 0;
            const avgProcessingSpeed = totalFiles > 0 ? (totalProcessingTime / totalFiles) : 0;
            const errorRate = totalUsage > 0 ? (errorCount / totalUsage * 100) : 0;

            document.getElementById('total-usage').textContent = `${totalUsage.toLocaleString()} 回`;
            document.getElementById('total-files').textContent = `${totalFiles.toLocaleString()} 枚`;
            document.getElementById('time-saved').textContent = `${timeSavedInHours} 時間`;
            document.getElementById('avg-automation-rate').textContent = `${avgAutomationRate.toFixed(1)} %`;
            document.getElementById('avg-processing-speed').textContent = `${avgProcessingSpeed.toFixed(2)} 秒/枚`;
            document.getElementById('error-rate').textContent = `${errorRate.toFixed(1)} %`;


            // --- 2. Update Charts ---
            updateTimeSeriesChart(logs);
            updateIndustryChart(logs);
            updateBrowserChart(logs);
            updateFileTypeChart(logs);
            updateTimeBreakdown(logs);
            updateUploadMethodChart(logs);
            updateFileCountScatterChart(logs);
            updateFileSizeScatterChart(logs);
        }
        
        /**
         * Handles data fetching and rendering, performing a differential update from cache.
         */
        async function handleUpdateAndRender() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';
            const period = document.getElementById('period-select').value;

            try {
                let latestTimestamp = null;
                let existingLogs = [];
                
                if (dataCache[period] && dataCache[period].length > 0) {
                    existingLogs = dataCache[period];
                    const maxMillis = Math.max(...existingLogs.map(log => log.eventTimestamp.toMillis()));
                    latestTimestamp = Timestamp.fromMillis(maxMillis);
                }

                const newLogs = await fetchUsageLogs(period, latestTimestamp);

                if (newLogs.length > 0) {
                    const combinedLogs = [...existingLogs, ...newLogs];
                    dataCache[period] = combinedLogs;
                    saveCacheToLocal(dataCache);
                    renderDashboardFromLogs(combinedLogs);
                    updateDataSourceInfo("キャッシュ + Firestore", combinedLogs.length, newLogs.length);
                } else if (existingLogs.length > 0) {
                    renderDashboardFromLogs(existingLogs);
                    updateDataSourceInfo("キャッシュ (最新)", existingLogs.length);
                } else {
                    dataCache[period] = newLogs; // which is empty array
                    saveCacheToLocal(dataCache);
                    renderDashboardFromLogs(newLogs);
                    updateDataSourceInfo("Firestore", newLogs.length);
                }

            } catch (error) {
                console.error("Error updating dashboard: ", error);
                alert("データの取得に失敗しました。コンソールログを確認してください。");
            } finally {
                loadingOverlay.style.display = 'none';
                document.getElementById('main-content').classList.add('opacity-100');
            }
        }

        /**
         * Calculates correlation coefficient (r) and linear regression parameters.
         * @param {Array<{x: number, y: number}>} data - Array of data points.
         * @returns {{r: number, slope: number, intercept: number, predict: function}}
         */
        function calculateCorrelationAndRegression(data) {
            if (data.length < 2) return { r: 0, slope: 0, intercept: 0, predict: x => x };
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
            const n = data.length;

            data.forEach(({ x, y }) => {
                sumX += x;
                sumY += y;
                sumXY += x * y;
                sumX2 += x * x;
                sumY2 += y * y;
            });

            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            
            const r = denominator === 0 ? 0 : numerator / denominator;

            const slopeDenominator = (n * sumX2 - sumX * sumX);
            const slope = slopeDenominator === 0 ? 0 : (n * sumXY - sumX * sumY) / slopeDenominator;
            const intercept = (sumY - slope * sumX) / n;

            return {
                r: r,
                slope: slope,
                intercept: intercept,
                predict: x => slope * x + intercept
            };
        }

        /**
         * Updates the time series chart with new data.
         */
        function updateTimeSeriesChart(logs) {
            const ctx = document.getElementById('time-series-chart').getContext('2d');
            const dataByDate = {};
            logs.forEach(log => {
                if (log.eventTimestamp) {
                    const date = dayjs(log.eventTimestamp.toDate()).format('YYYY-MM-DD');
                    if (!dataByDate[date]) {
                        dataByDate[date] = { usage: 0, files: 0 };
                    }
                    dataByDate[date].usage += 1;
                    dataByDate[date].files += log.fileCount || 0;
                }
            });
            const labels = Object.keys(dataByDate).sort();
            const usageData = labels.map(label => dataByDate[label].usage);
            const filesData = labels.map(label => dataByDate[label].files);
            
            if (timeSeriesChart) timeSeriesChart.destroy();
            timeSeriesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: '処理枚数', data: filesData, backgroundColor: 'rgba(59, 130, 246, 0.7)', yAxisID: 'yFiles' },
                        { label: '利用回数', data: usageData, borderColor: 'rgba(21, 128, 61, 1)', type: 'line', tension: 0.3, yAxisID: 'yUsage' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        yFiles: { type: 'linear', display: true, position: 'left', title: { display: true, text: '処理枚数 (枚)'}},
                        yUsage: { type: 'linear', display: true, position: 'right', title: { display: true, text: '利用回数 (回)'}, grid: { drawOnChartArea: false }}
                    }
                }
            });
        }

        /**
         * Updates the industry usage chart with new data.
         */
        function updateIndustryChart(logs) {
            const ctx = document.getElementById('industry-chart').getContext('2d');
            const industryCounts = logs.reduce((acc, log) => {
                const code = log.usedIndustryCode || '不明';
                acc[code] = (acc[code] || 0) + 1;
                return acc;
            }, {});
            const sorted = Object.entries(industryCounts).sort(([,a], [,b]) => b - a).slice(0, 5);
            
            if (industryChart) industryChart.destroy();
            industryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(item => item[0]),
                    datasets: [{
                        label: '利用回数',
                        data: sorted.map(item => item[1]),
                        backgroundColor: ['#3B82F6', '#10B981', '#EF4444', '#F59E0B', '#8B5CF6'],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }}}
            });
        }

        /**
         * Parses user agent string to get a simple browser name.
         */
        function parseBrowser(userAgent = '') {
            if (userAgent.includes('Firefox')) return 'Firefox';
            if (userAgent.includes('Edg')) return 'Edge';
            if (userAgent.includes('Chrome')) return 'Chrome';
            if (userAgent.includes('Safari')) return 'Safari';
            return 'Other';
        }

        /**
         * Updates the browser usage chart.
         */
        function updateBrowserChart(logs) {
            const ctx = document.getElementById('browser-chart').getContext('2d');
            const browserCounts = logs.reduce((acc, log) => {
                const browser = parseBrowser(log.userAgent);
                acc[browser] = (acc[browser] || 0) + 1;
                return acc;
            }, {});
            const sorted = Object.entries(browserCounts).sort(([,a], [,b]) => b - a);

            if (browserChart) browserChart.destroy();
            browserChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(item => item[0]),
                    datasets: [{
                        label: 'セッション数',
                        data: sorted.map(item => item[1]),
                        backgroundColor: ['#2563EB', '#F97316', '#059669', '#E11D48', '#7C3AED'],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }}}
            });
        }
        
        /**
         * Updates the file type usage chart.
         */
        function updateFileTypeChart(logs) {
            const ctx = document.getElementById('file-type-chart').getContext('2d');
            const fileTypeCounts = logs.reduce((acc, log) => {
                if(log.fileTypeCounts) {
                    for (const [type, count] of Object.entries(log.fileTypeCounts)) {
                        const upperType = type.toUpperCase();
                        acc[upperType] = (acc[upperType] || 0) + count;
                    }
                }
                return acc;
            }, {});
            const sorted = Object.entries(fileTypeCounts).sort(([,a], [,b]) => b - a);
            
            if (fileTypeChart) fileTypeChart.destroy();
            fileTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(item => item[0]),
                    datasets: [{
                        label: 'ファイル数',
                        data: sorted.map(item => item[1]),
                        backgroundColor: ['#D97706', '#047857', '#BE185D'],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }}}
            });
        }
        
        /**
         * Updates the processing time breakdown view.
         */
        function updateTimeBreakdown(logs) {
            const total = { thumbnail: 0, resize: 0, zip: 0 };
            let count = 0;
            logs.forEach(log => {
                if (log.timeBreakdown) {
                    total.thumbnail += log.timeBreakdown.thumbnail || 0;
                    total.resize += log.timeBreakdown.resize || 0;
                    total.zip += log.timeBreakdown.zip || 0;
                    count++;
                }
            });

            const avg = {
                thumbnail: count > 0 ? (total.thumbnail / count).toFixed(1) : '0.0',
                resize: count > 0 ? (total.resize / count).toFixed(1) : '0.0',
                zip: count > 0 ? (total.zip / count).toFixed(1) : '0.0',
            };

            document.getElementById('time-breakdown-thumbnail').textContent = avg.thumbnail;
            document.getElementById('time-breakdown-resize').textContent = avg.resize;
            document.getElementById('time-breakdown-zip').textContent = avg.zip;
        }

        function updateUploadMethodChart(logs) {
            const ctx = document.getElementById('upload-method-chart').getContext('2d');
            const methodCounts = logs.reduce((acc, log) => {
                const method = log.uploadMethod === 'drag_and_drop' ? 'DnD' : '選択';
                acc[method] = (acc[method] || 0) + 1;
                return acc;
            }, {});
            const sorted = Object.entries(methodCounts).sort(([,a], [,b]) => b - a);
            
            if (uploadMethodChart) uploadMethodChart.destroy();
            uploadMethodChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(item => item[0]),
                    datasets: [{
                        label: '回数',
                        data: sorted.map(item => item[1]),
                        backgroundColor: ['#4F46E5', '#0D9488'],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }}}
            });
        }

        function updateFileCountScatterChart(logs) {
            const ctx = document.getElementById('file-count-scatter-chart').getContext('2d');
            const scatterData = logs
                .map(log => ({ x: log.fileCount, y: log.processingTime }))
                .filter(d => typeof d.x === 'number' && typeof d.y === 'number');

            const stats = calculateCorrelationAndRegression(scatterData);
            document.getElementById('file-count-correlation').textContent = stats.r.toFixed(2);
            
            const xValues = scatterData.map(d => d.x);
            const minX = Math.min(...xValues);
            const maxX = Math.max(...xValues);
            const regressionLine = xValues.length > 1 ? [{x: minX, y: stats.predict(minX)}, {x: maxX, y: stats.predict(maxX)}] : [];

            if(fileCountScatterChart) fileCountScatterChart.destroy();
            fileCountScatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: '実データ',
                        data: scatterData,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    }, {
                        label: '回帰直線',
                        type: 'line',
                        data: regressionLine,
                        borderColor: 'rgba(239, 68, 68, 1)',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'ファイル数 (枚)' } },
                        y: { title: { display: true, text: '処理時間 (秒)' } }
                    }
                }
            });
        }

        function updateFileSizeScatterChart(logs) {
            const ctx = document.getElementById('file-size-scatter-chart').getContext('2d');
             const scatterData = logs
                .map(log => ({ x: log.totalFileSize, y: log.processingTime }))
                .filter(d => typeof d.x === 'number' && typeof d.y === 'number');

            const stats = calculateCorrelationAndRegression(scatterData);
            document.getElementById('file-size-correlation').textContent = stats.r.toFixed(2);
            
            const xValues = scatterData.map(d => d.x);
            const minX = Math.min(...xValues);
            const maxX = Math.max(...xValues);
            const regressionLine = xValues.length > 1 ? [{x: minX, y: stats.predict(minX)}, {x: maxX, y: stats.predict(maxX)}] : [];

            if(fileSizeScatterChart) fileSizeScatterChart.destroy();
            fileSizeScatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: '実データ',
                        data: scatterData,
                        backgroundColor: 'rgba(16, 185, 129, 0.5)',
                    }, {
                        label: '回帰直線',
                        type: 'line',
                        data: regressionLine,
                        borderColor: 'rgba(239, 68, 68, 1)',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                 options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: '合計ファイルサイズ (MB)' } },
                        y: { title: { display: true, text: '処理時間 (秒)' } }
                    }
                }
            });
        }
        
        // --- Event Listeners ---
        document.getElementById('update-button').addEventListener('click', handleUpdateAndRender);

        document.getElementById('period-select').addEventListener('change', (event) => {
            const selectedPeriod = event.target.value;
            if (dataCache[selectedPeriod]) {
                renderDashboardFromLogs(dataCache[selectedPeriod]);
                updateDataSourceInfo("キャッシュ", dataCache[selectedPeriod].length); 
            } else {
                 // If no cache, trigger a full fetch for the new period
                 handleUpdateAndRender();
            }
        });
        
        // --- Initial Load ---
        handleUpdateAndRender();

        // --- Modal Logic ---
        const cacheModal = document.getElementById('cache-modal');
        const confirmModal = document.getElementById('confirm-modal');
        
        const showCacheBtn = document.getElementById('show-cache-button');
        const clearCacheBtn = document.getElementById('clear-cache-button');
        const closeCacheBtn = document.getElementById('close-cache-button');

        const confirmOkBtn = document.getElementById('confirm-ok-button');
        const confirmCancelBtn = document.getElementById('confirm-cancel-button');
        
        const cacheTableBody = document.getElementById('cache-table-body');
        const emptyCacheMessage = document.getElementById('empty-cache-message');
        const cacheModalTitle = document.getElementById('cache-modal-title');
        
        function showModal(modalElement) {
            modalElement.classList.remove('hidden');
            modalElement.classList.add('flex');
            // Animate in
            setTimeout(() => modalElement.querySelector('.modal-enter')?.classList.add('modal-enter-active'), 10);
        }

        function hideModal(modalElement) {
             modalElement.querySelector('.modal-enter')?.classList.remove('modal-enter-active');
             setTimeout(() => {
                modalElement.classList.add('hidden');
                modalElement.classList.remove('flex');
             }, 200);
        }

        showCacheBtn.addEventListener('click', () => {
            try {
                cacheModalTitle.textContent = 'localStorage キャッシュデータ';
                const storedCacheJSON = localStorage.getItem('dataCache');
                
                cacheTableBody.innerHTML = ''; // Clear previous table content

                if (storedCacheJSON) {
                    const parsedCache = JSON.parse(storedCacheJSON);
                    const allLogs = Object.values(parsedCache).flat();
                    
                    if (allLogs.length > 0) {
                        allLogs.sort((a, b) => b.eventTimestamp - a.eventTimestamp); // Sort by newest first

                        const formatObject = (obj) => {
                            if (!obj) return '';
                            if (Array.isArray(obj) && obj.length === 0) return '';
                            return JSON.stringify(obj);
                        };

                        allLogs.forEach(log => {
                            const tr = document.createElement('tr');
                            tr.className = 'hover:bg-gray-50';
                            tr.innerHTML = `
                                <td class="px-4 py-2 whitespace-nowrap">${dayjs(log.eventTimestamp).format('YYYY-MM-DD HH:mm:ss')}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${log.usedIndustryCode || ''}</td>
                                <td class="px-4 py-2 text-right">${log.fileCount || 0}</td>
                                <td class="px-4 py-2 text-right">${log.totalFileSize ? log.totalFileSize.toFixed(1) : '0.0'}</td>
                                <td class="px-4 py-2 text-right">${log.processingTime ? log.processingTime.toFixed(2) : '0.00'}</td>
                                <td class="px-4 py-2 text-right">${log.sessionDuration ? log.sessionDuration.toFixed(2) : '0.00'}</td>
                                <td class="px-4 py-2">${log.submissionId || ''}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${log.uploadMethod || ''}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-xs">${formatObject(log.fileTypeCounts)}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-xs">${formatObject(log.timeBreakdown)}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-red-500 text-xs">${formatObject(log.errors)}</td>
                                <td class="px-4 py-2 truncate max-w-sm" title="${log.userAgent || ''}">${log.userAgent || ''}</td>
                                <td class="px-4 py-2 truncate max-w-xs" title="${log.sessionId || ''}">${log.sessionId || ''}</td>
                            `;
                            cacheTableBody.appendChild(tr);
                        });
                        emptyCacheMessage.classList.add('hidden');
                        cacheTableBody.parentElement.parentElement.classList.remove('hidden');
                    } else {
                        emptyCacheMessage.classList.remove('hidden');
                        cacheTableBody.parentElement.parentElement.classList.add('hidden');
                    }
                } else {
                    emptyCacheMessage.classList.remove('hidden');
                    cacheTableBody.parentElement.parentElement.classList.add('hidden');
                }
                showModal(cacheModal);
            } catch (error) {
                console.error("Error displaying cache:", error);
                emptyCacheMessage.textContent = 'キャッシュの表示に失敗しました。\n' + error;
                emptyCacheMessage.classList.remove('hidden');
                cacheTableBody.parentElement.parentElement.classList.add('hidden');
                showModal(cacheModal);
            }
        });

        closeCacheBtn.addEventListener('click', () => hideModal(cacheModal));
        clearCacheBtn.addEventListener('click', () => showModal(confirmModal));
        
        confirmCancelBtn.addEventListener('click', () => hideModal(confirmModal));
        confirmOkBtn.addEventListener('click', () => {
            localStorage.removeItem('dataCache');
            dataCache = {};
            hideModal(confirmModal);
            cacheModalTitle.textContent = "キャッシュをクリアしました。ページをリロードします...";
            
            // Re-show cache modal with clearing message
            showModal(cacheModal); 
            cacheTableBody.parentElement.parentElement.classList.add('hidden');
            emptyCacheMessage.textContent = "キャッシュをクリアしました。1.5秒後にページをリロードします...";
            emptyCacheMessage.classList.remove('hidden');

            setTimeout(() => {
                location.reload();
            }, 1500);
        });

    </script>
</body>
</html>

